"use strict"; var g = (e, i) => () => (i || e((i = { exports: {} }).exports, i), i.exports); var T = g(y => { "use strict"; var m = y && y.__decorate || function (e, i, t, n) { var a = arguments.length, o = a < 3 ? i : n === null ? n = Object.getOwnPropertyDescriptor(i, t) : n, r; if (typeof Reflect == "object" && typeof Reflect.decorate == "function") o = Reflect.decorate(e, i, t, n); else for (var s = e.length - 1; s >= 0; s--)(r = e[s]) && (o = (a < 3 ? r(o) : a > 3 ? r(i, t, o) : r(i, t)) || o); return a > 3 && o && Object.defineProperty(i, t, o), o }, w = y && y.__metadata || function (e, i) { if (typeof Reflect == "object" && typeof Reflect.metadata == "function") return Reflect.metadata(e, i) }; Object.defineProperty(y, "__esModule", { value: !0 }); y.correo = y.cliente = void 0; var c = require("./node_modules/sequelize-typescript/dist/index.js"), _ = class extends c.Model { }; m([c.NotEmpty, (0, c.AllowNull)(!1), (0, c.Column)(c.DataType.CHAR), w("design:type", String)], _.prototype, "dni", void 0); m([c.NotEmpty, (0, c.AllowNull)(!1), c.PrimaryKey, (0, c.Column)(c.DataType.CHAR), w("design:type", String)], _.prototype, "idcustomer", void 0); m([c.NotEmpty, (0, c.AllowNull)(!1), (0, c.Column)(c.DataType.CHAR), w("design:type", String)], _.prototype, "name", void 0); m([(0, c.HasOne)(() => v), w("design:type", Object)], _.prototype, "correo", void 0); _ = m([(0, c.Table)({ tableName: "clientes", timestamps: !1 })], _); y.cliente = _; var v = class extends c.Model { }; m([c.NotEmpty, (0, c.AllowNull)(!1), c.PrimaryKey, (0, c.ForeignKey)(() => _), (0, c.Column)(c.DataType.CHAR), w("design:type", String)], v.prototype, "idcustomer", void 0); m([(0, c.BelongsTo)(() => _), w("design:type", _)], v.prototype, "cliente", void 0); m([c.NotEmpty, (0, c.AllowNull)(!1), (0, c.Column)(c.DataType.CHAR), w("design:type", String)], v.prototype, "password", void 0); m([c.NotEmpty, (0, c.AllowNull)(!1), (0, c.Column)(c.DataType.CHAR), w("design:type", String)], v.prototype, "mail", void 0); v = m([(0, c.Table)({ tableName: "correos", timestamps: !1 })], v); y.correo = v }); var I = g(b => { "use strict"; var E = b && b.__awaiter || function (e, i, t, n) { function a(o) { return o instanceof t ? o : new t(function (r) { r(o) }) } return new (t || (t = Promise))(function (o, r) { function s(l) { try { u(n.next(l)) } catch (f) { r(f) } } function d(l) { try { u(n.throw(l)) } catch (f) { r(f) } } function u(l) { l.done ? o(l.value) : a(l.value).then(s, d) } u((n = n.apply(e, i || [])).next()) }) }; Object.defineProperty(b, "__esModule", { value: !0 }); b.logOut = b.searchClientOnDB = void 0; var k = T(), H = require("./node_modules/cookie/index.js"), Y = require("./node_modules/jsonwebtoken/index.js"), Z = (e, i) => E(void 0, void 0, void 0, function* () { let { idcustomer: t, dni: n } = e.body; yield k.cliente.findOne({ where: { dni: n, idcustomer: t }, include: [k.correo] }).then(a => { if (!a) i.sendStatus(400); else if (a) { let { mail: o, password: r, idcustomer: s } = a.correo, d = { mail: o, password: r, idcustomer: s }, u = process.env.SECRET_WORD || "f167f36e0a771941f0b287bbc19e4b5eb063a014d12bf9451396a65dc90d7a25", l = (0, Y.sign)(d, u), f = (0, H.serialize)("client_token", l, { httpOnly: !0, secure: !0, sameSite: "none", domain: ".cooperativaoyikil.com.ar", maxAge: 60 * 20, path: "/" }); i.setHeader("Set-Cookie", f), i.sendStatus(200) } }).catch(a => { i.sendStatus(400), console.log(a) }) }); b.searchClientOnDB = Z; var x = (e, i) => E(void 0, void 0, void 0, function* () { let t = (0, H.serialize)("client_token", "nulltoken", { httpOnly: !0, secure: !0, sameSite: "none", domain: ".cooperativaoyikil.com.ar", maxAge: -1, path: "/" }); try { i.sendStatus(202), i.append("Set-Cookie", t) } catch (n) { console.log(n) } }); b.logOut = x }); var z = g(O => { "use strict"; var ee = O && O.__awaiter || function (e, i, t, n) { function a(o) { return o instanceof t ? o : new t(function (r) { r(o) }) } return new (t || (t = Promise))(function (o, r) { function s(l) { try { u(n.next(l)) } catch (f) { r(f) } } function d(l) { try { u(n.throw(l)) } catch (f) { r(f) } } function u(l) { l.done ? o(l.value) : a(l.value).then(s, d) } u((n = n.apply(e, i || [])).next()) }) }, te = O && O.__importDefault || function (e) { return e && e.__esModule ? e : { default: e } }; Object.defineProperty(O, "__esModule", { value: !0 }); O.removeTemps = void 0; var ne = te(require("fs")); function oe(e) { return ee(this, void 0, void 0, function* () { e.forEach(i => { i.attachments.forEach(t => { setTimeout(() => { ne.default.unlink("." + t, () => { console.log(t + " eliminado") }) }, 3e4) }) }) }) } O.removeTemps = oe }); var L = g(p => { "use strict"; var j = p && p.__awaiter || function (e, i, t, n) { function a(o) { return o instanceof t ? o : new t(function (r) { r(o) }) } return new (t || (t = Promise))(function (o, r) { function s(l) { try { u(n.next(l)) } catch (f) { r(f) } } function d(l) { try { u(n.throw(l)) } catch (f) { r(f) } } function u(l) { l.done ? o(l.value) : a(l.value).then(s, d) } u((n = n.apply(e, i || [])).next()) }) }, ie = p && p.__rest || function (e, i) { var t = {}; for (var n in e) Object.prototype.hasOwnProperty.call(e, n) && i.indexOf(n) < 0 && (t[n] = e[n]); if (e != null && typeof Object.getOwnPropertySymbols == "function") for (var a = 0, n = Object.getOwnPropertySymbols(e); a < n.length; a++)i.indexOf(n[a]) < 0 && Object.prototype.propertyIsEnumerable.call(e, n[a]) && (t[n[a]] = e[n[a]]); return t }, re = p && p.__asyncValues || function (e) { if (!Symbol.asyncIterator) throw new TypeError("Symbol.asyncIterator is not defined."); var i = e[Symbol.asyncIterator], t; return i ? i.call(e) : (e = typeof __values == "function" ? __values(e) : e[Symbol.iterator](), t = {}, n("next"), n("throw"), n("return"), t[Symbol.asyncIterator] = function () { return this }, t); function n(o) { t[o] = e[o] && function (r) { return new Promise(function (s, d) { r = e[o](r), a(s, d, r.done, r.value) }) } } function a(o, r, s, d) { Promise.resolve(d).then(function (u) { o({ value: u, done: s }) }, r) } }, le = p && p.__importDefault || function (e) { return e && e.__esModule ? e : { default: e } }; Object.defineProperty(p, "__esModule", { value: !0 }); p.mailProcedure = void 0; var ae = require("./node_modules/imapflow/lib/imap-flow.js"), A = require("./node_modules/mailparser/index.js"), ce = le(require("fs")), se = e => j(void 0, void 0, void 0, function* () { let { mail: i, password: t } = e, n = process.env.MAIL_HOST || "www3.baehost.com", a = parseInt(process.env.MAIL_PORT || "") || 993, o = new ae.ImapFlow({ host: n, port: a, secure: !0, auth: { user: i, pass: t }, emitLogs: !1, logger: !1 }), r = yield ue(o); return r.length > 14 ? yield fe(o) : o.logout(), r.map(d => { var u, l, f, M; let { attachments: q } = d, G = ie(d, ["attachments"]), N = (u = q[0]) === null || u === void 0 ? void 0 : u.content, R = "./temp/" + ((f = (l = q[0]) === null || l === void 0 ? void 0 : l.filename) === null || f === void 0 ? void 0 : f.slice(0, -4)) + "_" + ((M = q[0]) === null || M === void 0 ? void 0 : M.cid) + Date.now() + ".pdf"; if (N) { let J = Buffer.from(N); return ce.default.createWriteStream(R).write(J), Object.assign(Object.assign({}, G), { attachments: [R.substring(1)] }) } else return d }) }); p.mailProcedure = se; var ue = e => j(void 0, void 0, void 0, function* () { var i, t; yield e.connect(); let n = [], a = yield e.getMailboxLock("INBOX"); try { try { for (var o = re(e.fetch("1:*", { envelope: !0, source: !0 })), r; r = yield o.next(), !r.done;) { let s = r.value; n.push({ subject: (yield (0, A.simpleParser)(s.source)).subject, attachments: (yield (0, A.simpleParser)(s.source)).attachments, date: (yield (0, A.simpleParser)(s.source)).date }) } } catch (s) { i = { error: s } } finally { try { r && !r.done && (t = o.return) && (yield t.call(o)) } finally { if (i) throw i.error } } } catch (s) { console.log(s) } finally { a.release() } return n }); function fe(e) { return j(this, void 0, void 0, function* () { let i = yield e.getMailboxLock("INBOX"); try { yield e.messageDelete("2:1") } catch (t) { console.log(t) } finally { i.release() } yield e.logout() }) } }); var K = g(S => { "use strict"; var de = S && S.__awaiter || function (e, i, t, n) { function a(o) { return o instanceof t ? o : new t(function (r) { r(o) }) } return new (t || (t = Promise))(function (o, r) { function s(l) { try { u(n.next(l)) } catch (f) { r(f) } } function d(l) { try { u(n.throw(l)) } catch (f) { r(f) } } function u(l) { l.done ? o(l.value) : a(l.value).then(s, d) } u((n = n.apply(e, i || [])).next()) }) }, pe = S && S.__importDefault || function (e) { return e && e.__esModule ? e : { default: e } }; Object.defineProperty(S, "__esModule", { value: !0 }); S.eMailController = void 0; var _e = pe(require("./node_modules/jsonwebtoken/index.js")), ye = z(), me = L(), he = (e, i) => de(void 0, void 0, void 0, function* () { let { client_token: t } = e.cookies, n = t ? _e.default.verify(t, "f167f36e0a771941f0b287bbc19e4b5eb063a014d12bf9451396a65dc90d7a25") : null; if (n) { let { password: a, mail: o, idcustomer: r } = n, s = { mail: o, password: a }, d = yield (0, me.mailProcedure)(s); i.status(200).send({ idcustomer: r, mails: d }), yield (0, ye.removeTemps)(d) } else i.sendStatus(401) }); S.eMailController = he }); var X = g(C => { "use strict"; var P = C && C.__importDefault || function (e) { return e && e.__esModule ? e : { default: e } }; Object.defineProperty(C, "__esModule", { value: !0 }); var B = P(require("./node_modules/express/index.js")), W = I(), ve = P(require("./node_modules/cookie-parser/index.js")), F = K(), U = P(require("./node_modules/cors/lib/index.js")), V = { credentials: !0, origin: ["https://martintorres-webportfolio.com.ar/", /\.martintorres-webportfolio\.com\.ar$/] }, h = (0, B.default)(); h.use(B.default.json()); h.use((0, ve.default)()); h.use((0, U.default)(V)); h.options("*", (0, U.default)(V)); h.use("/temp", B.default.static("./temp")); h.post("/", W.searchClientOnDB); h.post("/logout", W.searchClientOnDB); h.get("/facturas", F.eMailController); h.get("/", F.eMailController); C.default = h }); var $ = g(D => { "use strict"; Object.defineProperty(D, "__esModule", { value: !0 }); D.conChain = void 0; var we = require("./node_modules/sequelize-typescript/dist/index.js"), Q = T(), be = process.env.DB_HOST || "www.cooperativaoyikil.com.ar", Oe = process.env.DB_NAME || "coopera3_facturacion", Se = process.env.DB_USER || "coopera3_facturador_admin", ge = process.env.DB_PASS || "oyikilSQL22_"; D.conChain = new we.Sequelize(Oe, Se, ge, { host: be, dialect: "mariadb", pool: { max: 700, min: 3, acquire: 3e4, idle: 1e4 }, logging: !1, models: [Q.cliente, Q.correo] }) }); var Ce = exports && exports.__awaiter || function (e, i, t, n) { function a(o) { return o instanceof t ? o : new t(function (r) { r(o) }) } return new (t || (t = Promise))(function (o, r) { function s(l) { try { u(n.next(l)) } catch (f) { r(f) } } function d(l) { try { u(n.throw(l)) } catch (f) { r(f) } } function u(l) { l.done ? o(l.value) : a(l.value).then(s, d) } u((n = n.apply(e, i || [])).next()) }) }, De = exports && exports.__importDefault || function (e) { return e && e.__esModule ? e : { default: e } }; Object.defineProperty(exports, "__esModule", { value: !0 }); var Me = De(X()), qe = $(), Te = () => Ce(void 0, void 0, void 0, function* () { let e = process.env.PORT || 3040; yield qe.conChain.sync(), Me.default.listen(e, () => { console.log("El servidor esta listo para pedir peticiones en el puerto: " + e) }) }); Te();
